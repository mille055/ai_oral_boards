stages:
  - build
  - deploy
variables:
  RUST_VERSION: "stable"
  AWS_DEFAULT_REGION: "us-east-1"
  LAMBDA_FUNCTION_NAME: "radiology-teaching-files"
  S3_BUCKET: "radiology-teaching-files"
  DYNAMODB_TABLE: "RadiologyTeachingFiles"
  AWS_LAMBDA_ROLE: "arn:aws:iam::083702193891:role/lambda-radiology-role" # Replace with your actual role ARN

# -------------------------------------
# üìå Frontend Build Stage (Node.js)
# -------------------------------------
# build-frontend:
#   stage: build
#   image: node:18
#   script:
#     - cd frontend
#     - npm install
#     - npm run lint
#     - npm run build
#     - cd ..
#     - mkdir -p build-artifacts/frontend
#     - echo "‚úÖ Listing frontend directory after build:"
#     - ls -lah frontend/
#     - echo "‚úÖ Checking frontend/build directory:"
#     #- ls -lah frontend/build/ || echo "‚ö†Ô∏è Warning: frontend/build/ does not exist! Checking alternative directories..."
#     - ls -lah frontend/build/ || echo 
#     # Create a basic structure if build directory doesn't exist
#     - |
#       if [ ! -d "frontend/build" ]; then 
#         mkdir -p frontend/build
#         echo "index.html" > frontend/build/index.html
#       fi
#     - |
#       cp -r frontend/build/* build-artifacts/frontend/ || echo "Warning: No build files found, creating placeholder"
#     - |
#       if [ ! -f "build-artifacts/frontend/index.html" ]; then 
#         echo "<html><body><h1>Radiology Teaching Files</h1><p>Frontend placeholder</p></body></html>" > build-artifacts/frontend/index.html
#       fi
#   artifacts:
#     paths:
#       - build-artifacts/frontend/
#     expire_in: 1 week

# -------------------------------------
# üìå Backend Build Stage (Rust + Lambda)
# -------------------------------------
build-backend:
  stage: build
  image: ghcr.io/cargo-lambda/cargo-lambda:latest # ‚úÖ Pre-built Lambda Rust image
  script:
    - cargo lambda build --release --arm64
    - echo "‚úÖ Listing Lambda build output:"
    - ls -lah target/lambda/
    - mkdir -p build-artifacts/lambda
    - |
      cp target/lambda/radiology-teaching-files/bootstrap build-artifacts/lambda/bootstrap || echo "‚ùå ERROR: No bootstrap binary found!"
    - echo "‚úÖ Final Lambda artifacts:"
    - ls -lah build-artifacts/lambda/
  artifacts:
    paths:
      - build-artifacts/lambda/
    expire_in: 1 week

# -------------------------------------
# üìå Frontend Deployment to S3
# -------------------------------------
# deploy-frontend:
#   stage: deploy
#   image: amazon/aws-cli
#   script:
#     - aws --version
#     - echo "‚úÖ Checking frontend artifacts before deployment:"
#     - ls -lah build-artifacts/frontend/
#     - echo "‚úÖ Deploying frontend files to S3..."
#     - aws s3 sync build-artifacts/frontend/ s3://$S3_BUCKET/frontend/ --acl public-read
#     - echo "‚úÖ S3 deployment complete. Verifying upload:"
#     - aws s3 ls s3://$S3_BUCKET/frontend/
#   dependencies:
#     - build-frontend
#   only:
#     - main
#   environment:
#     name: production

# -------------------------------------
# üìå Backend Deployment to Lambda
# -------------------------------------
deploy-backend:
  stage: deploy
  image: ghcr.io/cargo-lambda/cargo-lambda:latest
  script:
    - echo "‚úÖ Checking backend artifacts before deployment:"
    - ls -lah build-artifacts/lambda/
    #- if [ ! -f build-artifacts/lambda/radiology-teaching-files/bootstrap ]; then echo "‚ùå ERROR: No Lambda bootstrap binary found!"; exit 1; fi
    - echo "‚úÖ Found Lambda binary, proceeding with deployment..."
    #- cargo lambda deploy --iam-role $AWS_LAMBDA_ROLE --region $AWS_DEFAULT_REGION $LAMBDA_FUNCTION_NAME
    - cargo lambda deploy --iam-role $AWS_LAMBDA_ROLE --region $AWS_DEFAULT_REGION --binary build-artifacts/lambda/bootstrap $LAMBDA_FUNCTION_NAME
  dependencies:
    - build-backend
  only:
    - main
  environment:
    name: production
